-- Pentest Memo: 左下に固定表示するメモウィンドウ
local M = {}

local buf = nil
local win = nil

local config = {
  width = 25,
  height = 5,
  title = " Pentest Memo ",
}

function M.is_open()
  return win and vim.api.nvim_win_is_valid(win)
end

function M.open()
  -- バッファがなければ作成
  if not buf or not vim.api.nvim_buf_is_valid(buf) then
    buf = vim.api.nvim_create_buf(false, true)
    vim.api.nvim_buf_set_option(buf, 'buftype', 'nofile')
    vim.api.nvim_buf_set_option(buf, 'bufhidden', 'hide')
    vim.api.nvim_buf_set_option(buf, 'swapfile', false)
    vim.api.nvim_buf_set_option(buf, 'filetype', 'markdown')
    -- 初期テンプレート
    vim.api.nvim_buf_set_lines(buf, 0, -1, false, {
      "LHOST: ",
      "RHOST: ",
    })
  end

  -- 既に開いていれば何もしない
  if M.is_open() then
    return
  end

  -- 左下に配置
  local row = vim.o.lines - config.height - 4
  local col = 2

  win = vim.api.nvim_open_win(buf, false, {
    relative = 'editor',
    width = config.width,
    height = config.height,
    row = row,
    col = col,
    style = 'minimal',
    border = 'rounded',
    title = config.title,
    title_pos = 'center',
    zindex = 50,
  })

  -- ウィンドウ設定
  vim.api.nvim_win_set_option(win, 'winblend', 10)
  vim.api.nvim_win_set_option(win, 'winhighlight', 'Normal:DiagnosticError,FloatBorder:DiagnosticError,FloatTitle:DiagnosticError')
end

function M.close()
  if M.is_open() then
    vim.api.nvim_win_close(win, true)
    win = nil
  end
end

function M.toggle()
  if M.is_open() then
    M.close()
  else
    M.open()
  end
end

function M.focus()
  if M.is_open() then
    vim.api.nvim_set_current_win(win)
  else
    M.open()
    vim.api.nvim_set_current_win(win)
  end
end

-- キーマップ設定
function M.setup()
  vim.keymap.set('n', '<leader>p', M.toggle, { noremap = true, silent = true, desc = "Toggle Pentest Memo" })
  vim.keymap.set('n', '<leader>P', M.focus, { noremap = true, silent = true, desc = "Focus Pentest Memo" })
end

return M
