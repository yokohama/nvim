local api = vim.api
local cmd = vim.cmd
local fn  = vim.fn

api.nvim_create_user_command("PEN", function()
  cmd("only")

  local total_cols  = vim.o.columns
  local total_lines = vim.o.lines

  local left_w   = math.floor(total_cols * 0.14)
  local center_w = math.floor(total_cols * 0.30)
  local right_w  = total_cols - left_w - center_w
  local right_top_h = math.floor(total_lines * 0.40)
  local right_middle_h = math.floor(total_lines * 0.40)

  -- 中央
  local win_center = api.nvim_get_current_win()

  -- 右
  cmd("rightbelow vsplit")
  local win_right_top = api.nvim_get_current_win()

  -- 左
  api.nvim_set_current_win(win_center)
  cmd("leftabove vsplit")
  local win_left = api.nvim_get_current_win()

  require("nvim-tree.api").tree.open({
    winid = win_left,
    focus = false,
  })

  -- 横幅固定
  api.nvim_set_current_win(win_left)
  cmd("vertical resize " .. left_w)
  cmd("setlocal winfixwidth")

  api.nvim_set_current_win(win_center)
  cmd("vertical resize " .. center_w)
  cmd("setlocal winfixwidth")

  api.nvim_set_current_win(win_right_top)
  cmd("vertical resize " .. right_w)
  cmd("setlocal winfixwidth")

  -- 右を上中下分割
  api.nvim_set_current_win(win_right_top)
  cmd("split")
  local win_right_middle = api.nvim_get_current_win()

  cmd("split")
  local win_right_bottom = api.nvim_get_current_win()

  -- 右上：terminal
  api.nvim_set_current_win(win_right_top)
  cmd("terminal")
  cmd("resize " .. right_top_h)
  cmd("setlocal winfixheight")

  -- 右中：terminal
  api.nvim_set_current_win(win_right_middle)
  cmd("terminal")
  cmd("resize " .. right_middle_h)
  cmd("setlocal winfixheight")


  -- 右下：pen-info.md
  api.nvim_set_current_win(win_right_bottom)
  local info_path = fn.getcwd() .. "/pen-info.md"
  if fn.filereadable(info_path) == 0 then
    fn.writefile({}, info_path)
  end
  cmd("edit " .. info_path)
  cmd("setlocal winfixheight")

  -- 最終フォーカス
  api.nvim_set_current_win(win_center)
end, {})
